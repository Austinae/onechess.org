$(document).ready(function(){var e=window.location.href.match(/([\w\d_-]*)\.?[^\\\/]*$/i)[1];$.get("/initData/"+e,function(t){var[i,o,s,n,r,a,p,c,l,g,m,d,u,h,v,b,S,f,y,w,C,k,M,N,P,T,q,A,E,I,B,L,D,x,H,O,X,Y,z,R,F,J]=[io(),t.eyeView,document.getElementById("board"),"abcdefghijklmnopqrstuvwxyz","white"==t.eyeView||"spectator"==t.eyeView?"white":"black",t.increment,t.live,t.time,t.variant,t.busername,t.bcountry,t.brw,t.brx,t.brs,t.wusername,t.wcountry,t.wrw,t.wrx,t.wrs,document.getElementById("player1"),document.getElementById("player2"),document.getElementById("datagameinfo"),document.getElementById("dataplayer1"),document.getElementById("dataplayer2"),{white:t.wusername,black:t.busername},document.getElementById("eyeNb"),document.getElementById("moveNb")];window.onbeforeunload=function(){return void i.emit("leaveRoom",e)},document.getElementById("playertime").innerHTML="&nbsp;"+c+":00",document.getElementById("opponenttime").innerHTML="&nbsp;"+c+":00",i.emit("setRoom",e);var W=s.getContext("2d");if(3==l)var V=document.getElementById("capturedOne"),U=V.getContext("2d"),G=document.getElementById("capturedTwo"),K=G.getContext("2d"),$=document.getElementById("sbOne"),j=document.getElementById("sbTwo"),_=document.getElementById("valuesPawnOne"),Q=document.getElementById("valuesPawnTwo"),Z=document.getElementById("valuesLanceOne"),ee=document.getElementById("valuesLanceTwo"),te=document.getElementById("valuesKnightOne"),ie=document.getElementById("valuesKnightTwo"),oe=document.getElementById("valuesSilverOne"),se=document.getElementById("valuesSilverTwo"),ne=document.getElementById("valuesGoldOne"),re=document.getElementById("valuesGoldTwo"),ae=document.getElementById("valuesBishopOne"),pe=document.getElementById("valuesBishopTwo"),ce=document.getElementById("valuesRookOne"),le=document.getElementById("valuesRookTwo");function ge(e,t){return e.indexOf(t)>-1}function me(e,t){var i,o,s;for(i=0;i<e.length;++i)if(t.length===e[i].length){for(s=e[i],o=0;o<t.length&&t[o]===s[o];++o);if(o===t.length)return!0}return!1}function de(e,t){if(e===t)return!0;if(null==e||null==t)return!1;if(e.length!==t.length)return!1;for(var i=0;i<e.length;++i)if(e[i]!==t[i])return!1;return!0}function ue(e,t){var i,s=[];if("white"==o)for(i=0;i<t;i++)s.push(e[0]+(e.substring(1)-i));else for(i=0;i<t;i++)s.push(e[0]+(parseInt(e.substring(1))+i));return s}function he(e){var t=e[0],i=e.substring(1)-1;return"white"==r?(t=n.indexOf(t),i=-i+B-1):t=-(t=n.indexOf(t))+I-1,[t,i]}function ve(e){return[n.indexOf(e[0]),e.substring(1)-1]}function be(e){return n[e[0]]+(e[1]+1)}function Se(e){return(new Date).getTime()-e}function fe(e){var t=Date.now();return new Date(t+=e)}function ye(e,t){var i=countdown(Date.now(),fe(e),countdown.MINUTES|countdown.SECONDS);document.getElementById(t).innerHTML="&nbsp;"+i.minutes+":"+(i.seconds<10?"0":"")+i.seconds,"playertime"==t?document.getElementById("timerplayer2").style.backgroundColor="grey":document.getElementById("timerplayer1").style.backgroundColor="grey"}function we(t,s){"playertime"==s?document.getElementById("timerplayer2").style.backgroundColor="white":document.getElementById("timerplayer1").style.backgroundColor="white";var n=countdown(t,t=>{document.getElementById(s).innerHTML="&nbsp;"+t.minutes+":"+(t.seconds<10?"0":"")+t.seconds,0==t.minutes&&0==t.seconds&&function(t){window.clearInterval(t),("white"==o||"black"==o)&&(Oe()?(i.emit("gameover",{gid:e,type:"timeover",winnercolour:He(o)}),alert("timeover, you lost on time")):(i.emit("gameover",{gid:e,type:"timeover",winnercolour:o}),alert("timeover, you won on time")))}(n)},countdown.MINUTES|countdown.SECONDS);return n}function Ce(e){window.clearInterval(e)}function ke(e){var t={gameMode:e.gameMode,timeremaining:e.timeremaining,moveNb:e.moveNb,check:e.check,lastMove:e.lastMove,pieces:[]};for(var i in e.pieces)t.pieces.push({pid:e.pieces[i].pid,alive:e.pieces[i].alive,numberMoves:e.pieces[i].numberMoves,positionStr:e.pieces[i].positionStr,positionCoord:e.pieces[i].positionCoord,originalType:e.pieces[i].originalType,type:e.pieces[i].type,colour:e.pieces[i].colour,spriteCoord:e.pieces[i].spriteCoord});return t}function Me(e,t,i){var o,s,n,r,a=!1;for(var p in t.pieces)if((n=t.pieces[p]).colour==i&&n.alive&&"king"==n.type){s=n.positionStr;break}for(var p in o=e.getSquareOccupancy(t,He(i)),t.pieces){if((n=t.pieces[p]).colour==He(i)&&n.alive)for(var c in(r=e.getPieceMoves(n,o[0],o[1])).canAttack)if(r.canAttack[c]==s){a=!0;break}if(1==a)break}return!!a&&{positionStr:s}}function Ne(e,t,i,o,s,n=null,r=null,a=null,p=null){null!=a?(e.save(),e.translate(n,r),e.rotate(a*Math.PI/180),null!=p&&(e.globalAlpha=.8),e.drawImage(t.images.pieces,i[0]*t.subSizeX,i[1]*t.subSizeY,t.subSizeX,t.subSizeY,-o[0]*s+(n-50),-o[1]*s+(r-50),s,s),null!=p&&(e.globalAlpha=1),e.restore()):(null!=p&&(e.globalAlpha=.8),e.drawImage(t.images.pieces,i[0]*t.subSizeX,i[1]*t.subSizeY,t.subSizeX,t.subSizeY,o[0]*s,o[1]*s,s,s),null!=p&&(e.globalAlpha=1))}function Pe(e,t,i,o=null,s=null){null!=s&&(e.fillStyle=s),null!=o&&(e.globalAlpha=.8),e.fillRect(t[0]*i,t[1]*i,i,i),null!=o&&(e.globalAlpha=1)}function Te(e){switch(e){case"pawn":return"a1";case"lance":return"b1";case"knight":return"c1";case"silver":return"a2";case"gold":return"b2";case"bishop":return"c2";case"rook":return"a3"}}function qe(e){switch(e){case"a1":return"pawn";case"b1":return"lance";case"c1":return"knight";case"a2":return"silver";case"b2":return"gold";case"c2":return"bishop";case"a3":return"rook"}}function Ae(e,t,i,o,s,n){0!=t[i][o]?(e.parentNode.style.display="block",e.innerHTML="&nbsp;"+t[i][o],r==s?"white"==r?Ne(K,D,D.coordinates[n(o,s)],ve(Te(o)),L,150,150,180,.2):Ne(K,D,D.coordinates[n(o,s)],ve(Te(o)),L,null,null,null,.2):"white"==r?Ne(U,D,D.coordinates[n(o,s)],ve(Te(o)),L,150,150,180,.2):Ne(U,D,D.coordinates[n(o,s)],ve(Te(o)),L,null,null,null,.2)):e.parentNode.style.display="none"}function Ee(e,t){var i,o;if(W.clearRect(0,0,e.cwidth,e.cheight),W.drawImage(e.images.board,0,0,e.cwidth,e.cheight),3==l){U.clearRect(0,0,e.cCptOneWidth,e.cCptOneHeight),K.clearRect(0,0,e.cCptTwoWidth,e.cCptTwoHeight),U.drawImage(e.images.sideboard,0,0,e.cCptOneWidth,e.cCptOneHeight),K.drawImage(e.images.sideboard,0,0,e.cCptTwoWidth,e.cCptTwoHeight);var n=e.prisoners;"white"==r?(Ae(_,n,"bDeadPieces","pawn","black",e.getSpriteCoord),Ae(Q,n,"wDeadPieces","pawn","white",e.getSpriteCoord),Ae(Z,n,"bDeadPieces","lance","black",e.getSpriteCoord),Ae(ee,n,"wDeadPieces","lance","white",e.getSpriteCoord),Ae(te,n,"bDeadPieces","knight","black",e.getSpriteCoord),Ae(ie,n,"wDeadPieces","knight","white",e.getSpriteCoord),Ae(oe,n,"bDeadPieces","silver","black",e.getSpriteCoord),Ae(se,n,"wDeadPieces","silver","white",e.getSpriteCoord),Ae(ne,n,"bDeadPieces","gold","black",e.getSpriteCoord),Ae(re,n,"wDeadPieces","gold","white",e.getSpriteCoord),Ae(ae,n,"bDeadPieces","bishop","black",e.getSpriteCoord),Ae(pe,n,"wDeadPieces","bishop","white",e.getSpriteCoord),Ae(ce,n,"bDeadPieces","rook","black",e.getSpriteCoord),Ae(le,n,"wDeadPieces","rook","white",e.getSpriteCoord)):(Ae(_,n,"wDeadPieces","pawn","white",e.getSpriteCoord),Ae(Q,n,"bDeadPieces","pawn","black",e.getSpriteCoord),Ae(Z,n,"wDeadPieces","lance","white",e.getSpriteCoord),Ae(ee,n,"bDeadPieces","lance","black",e.getSpriteCoord),Ae(te,n,"wDeadPieces","knight","white",e.getSpriteCoord),Ae(ie,n,"bDeadPieces","knight","black",e.getSpriteCoord),Ae(oe,n,"wDeadPieces","silver","white",e.getSpriteCoord),Ae(se,n,"bDeadPieces","silver","black",e.getSpriteCoord),Ae(ne,n,"wDeadPieces","gold","white",e.getSpriteCoord),Ae(re,n,"bDeadPieces","gold","black",e.getSpriteCoord),Ae(ae,n,"wDeadPieces","bishop","white",e.getSpriteCoord),Ae(pe,n,"bDeadPieces","bishop","black",e.getSpriteCoord),Ae(ce,n,"wDeadPieces","rook","white",e.getSpriteCoord),Ae(le,n,"bDeadPieces","rook","black",e.getSpriteCoord))}if(0!=e.eyeNb&&null!=e.gameStates[t].lastMove.originStr&&null!=e.gameStates[t].lastMove.destinationStr&&(Pe(W,he(e.gameStates[t].lastMove.originStr),L,alpha=.5,fillStyle="#00ccff"),Pe(W,he(e.gameStates[t].lastMove.destinationStr),L,alpha=.5,fillStyle="#00ccff")),null!=e.focus.piece){for(var a in null!=e.focus.piece.positionStr&&Pe(W,he(e.focus.piece.positionStr),L,alpha=.8,fillStyle="#8080ff"),e.focus.validSquares.canMove)Pe(W,he(e.focus.validSquares.canMove[a]),L,alpha=.8,fillStyle="#cc6600");for(var a in e.focus.validSquares.canAttack)Pe(W,he(e.focus.validSquares.canAttack[a]),L,alpha=.8,fillStyle="#ff3300")}for(var p in 0!=e.gameStates[t].check&&Pe(W,he(e.gameStates[t].check.positionStr),L,alpha=.8,fillStyle="#ff1a1a"),e.gameStates[t].pieces)(i=e.gameStates[t].pieces[p]).alive&&(3!=l||3==l&&"black"==r?Ne(W,e,e.coordinates[i.spriteCoord],he(i.positionStr),L):Ne(W,e,e.coordinates[i.spriteCoord],he(i.positionStr),L,cwidth=s.width,cheight=s.height,degree=180));if(e.promoting)for(var c in W.globalAlpha=.7,W.fillStyle="#4d0000",W.fillRect(0,0,e.cwidth,e.cheight),W.globalAlpha=1,o=ue(e.promotingSquare,e.promotionConfigs.length),e.promotionConfigs)Ne(W,e,e.coordinates[e.promotionConfigs[c].spriteCoord],he(o[c]),L)}class Ie{constructor(){this.nbSqPSideX,this.nbSqPSideY,this.images={board:null,pieces:null},this.moveNb=0,this.gameStates=[],this.focus={piece:null,validSquares:null},this.eyeNb=0,this.moves={},this.promotionConfigs=[],this.promotingChoice=[],this.promoting=!1,this.promotingSquare}getSquareOccupancy(e,t){var i,o=[],s=[];for(var n in e.pieces)(i=e.pieces[n]).alive&&(i.colour==t?o.push(i.positionCoord):s.push(i.positionCoord));return[o,s]}generateValidMoves(){var e,t,i,s=this.getSquareOccupancy(this.gameStates[this.moveNb],o),n=s[0],r=s[1];for(var a in this.gameStates[this.moveNb].pieces)(e=this.gameStates[this.moveNb].pieces[a]).colour==o&&e.alive?this.moves[e.pid]=this.getPieceMoves(e,n,r):e.colour==o&&3==l&&0==e.alive&&(this.moves[e.pid]=this.getPieceMoves(e,n,r));var p,c={};for(var a in this.moves){for(var g in p={canMove:[],canAttack:[]},this.moves[a].canMove)if(u=!0,t=this.moves[a].canMove[g],(i=ke(this.gameStates[this.moveNb])).pieces[a].positionStr=t,i.pieces[a].positionCoord=ve(t),i.pieces[a].alive=!0,0==Me(this,i,o))if(2==l){var m=this.getSquareOccupancy(i,o),d=m[0].concat(m[1]),u=!1;for(var h in i.pieces)if(4==i.pieces[h].pid&&(S=i.pieces[h].positionCoord),20==i.pieces[h].pid){f=i.pieces[h].positionCoord;break}if(S[0]==f[0]){for(var v=S[1]+1;v<f[1];v++)if(me(d,[S[0],v])){u=!0;break}u&&p.canMove.push(t)}else p.canMove.push(t)}else p.canMove.push(t);for(var g in this.moves[a].canAttack){for(var b in u=!0,t=this.moves[a].canAttack[g],(i=ke(this.gameStates[this.moveNb])).pieces)if(i.pieces[b].positionStr==t&&i.pieces[b].alive){(e=i.pieces[b]).alive=!1;break}if(i.pieces[a].positionStr=t,i.pieces[a].positionCoord=ve(t),0==Me(this,i,o))if(2==l){var S,f;d=r.concat(n),u=!1;for(var h in i.pieces)if(4==i.pieces[h].pid&&(S=i.pieces[h].positionCoord),20==i.pieces[h].pid){f=i.pieces[h].positionCoord;break}if(S[0]==f[0])for(v=S[1]+1;v<f[1];v++)if(me(d,[S[0],v])){u=!0;break}u&&p.canAttack.push(t)}else p.canAttack.push(t)}c[a]=p}this.moves=c}isInsideField(e,t){return e[0]>t[0]&&e[0]<t[1]&&e[1]>t[2]&&e[1]<t[3]}generatePositions(e,t,i,o,s,n,r=!0,a=!1){var p,c,l={canMove:[],canAttack:[]};for(var g in t){var m=t[g];for((p=[e[0],e[1]])[0]+=m[0],p[1]+=m[1],c=0;this.isInsideField(p,n);){if(me(o,p)){if(!a)break;if(0!=c)break;c+=1}else if(me(s,p)){if(0==a){if(r){l.canAttack.push(be(p));break}break}if(0!=c){l.canAttack.push(be(p));break}r?l.canAttack.push(be(p)):c+=1}else 0==a?l.canMove.push(be(p)):0==c&&l.canMove.push(be(p));if("singular"==i)break;p[0]+=m[0],p[1]+=m[1]}}return l}}class Be extends Ie{constructor(){super(),this.variant=1,this.type="international",this.cwidth=400,this.cheight=400,this.nbSqPSideX=8,this.nbSqPSideY=8,this.subSizeX=45,this.subSizeY=45,this.imageSrcs=["images/international/pieces.svg","images/international/board.png"],this.coordinates={0:[0,0],1:[0,1],2:[1,0],3:[1,1],4:[2,0],5:[2,1],6:[3,0],7:[3,1],8:[4,0],9:[4,1],10:[5,0],11:[5,1]}}getPromotionConfigs(e,t){var i=[];switch(e.type){case"pawn":8!=t[1]&&1!=t[1]||("white"==e.colour?(i.push({type:"queen",spriteCoord:2}),i.push({type:"rook",spriteCoord:8}),i.push({type:"bishop",spriteCoord:4}),i.push({type:"knight",spriteCoord:6})):(i.push({type:"queen",spriteCoord:3}),i.push({type:"rook",spriteCoord:9}),i.push({type:"bishop",spriteCoord:5}),i.push({type:"knight",spriteCoord:7})))}return i}areCastlingSquaresCheckFree(e,t,i){var s,n,r=20==t?4:20;n="white"==o?"qs"==i?["c1","d1"]:["f1","g1"]:"qs"==i?["c8","d8"]:["f8","g8"];var a=ke(e);for(var p in a.pieces)if(a.pieces[p].pid==r){a.pieces[p].numberMoves=1;break}for(var p in a.pieces)if(a.pieces[p].pid==t){if(a.pieces[p].positionStr=n[0],a.pieces[p].positionCoord=ve(n[0]),a.pieces[p].numberMoves=1,0!=(s=Me(this,a,o))){s=!1;break}if(a.pieces[p].positionStr=n[1],a.pieces[p].positionCoord=ve(n[1]),a.pieces[p].numberMoves=1,0!=(s=Me(this,a,o))){s=!1;break}s=!0;break}return 1==s}getPieceMoves(e,t,i){var o;switch(e.type){case"king":var s;o=this.generatePositions(e.positionCoord,[[-1,1],[-1,0],[-1,-1],[0,1],[0,-1],[1,1],[1,0],[1,-1]],"singular",t,i,[-1,8,-1,8]);var n=i.concat(t);if(0==this.gameStates[this.moveNb].check&&0==e.numberMoves)for(var r in this.gameStates[this.moveNb].pieces)if(s=this.gameStates[this.moveNb].pieces[r],"white"==e.colour){if(0==s.pid&&0==s.numberMoves&&s.alive&&(me(n,ve("d1"))||me(n,ve("c1"))||1==this.areCastlingSquaresCheckFree(this.gameStates[this.moveNb],4,"qs")&&o.canMove.push("c1")),7==s.pid){0==s.numberMoves&&s.alive&&(me(n,ve("f1"))||me(n,ve("g1"))||1==this.areCastlingSquaresCheckFree(this.gameStates[this.moveNb],4,"ks")&&o.canMove.push("g1"));break}}else if(16==s.pid&&0==s.numberMoves&&s.alive&&(me(n,ve("d8"))||me(n,ve("c8"))||1==this.areCastlingSquaresCheckFree(this.gameStates[this.moveNb],20,"qs")&&o.canMove.push("c8")),23==s.pid){0==s.numberMoves&&s.alive&&(me(n,ve("f8"))||me(n,ve("g8"))||1==this.areCastlingSquaresCheckFree(this.gameStates[this.moveNb],20,"ks")&&o.canMove.push("g8"));break}return o;case"queen":return this.generatePositions(e.positionCoord,[[-1,1],[-1,0],[-1,-1],[0,1],[0,-1],[1,1],[1,0],[1,-1]],"plural",t,i,[-1,8,-1,8]);case"bishop":return this.generatePositions(e.positionCoord,[[-1,1],[1,1],[1,-1],[-1,-1]],"plural",t,i,[-1,8,-1,8]);case"knight":return this.generatePositions(e.positionCoord,[[-2,1],[-1,2],[1,2],[2,1],[2,-1],[1,-2],[-1,-2],[-2,-1]],"singular",t,i,[-1,8,-1,8]);case"rook":return this.generatePositions(e.positionCoord,[[-1,0],[0,1],[1,0],[0,-1]],"plural",t,i,[-1,8,-1,8]);case"pawn":var a,p,c;n=i.concat(t);if("white"==e.colour){var l;0==e.numberMoves?(o=this.generatePositions(e.positionCoord,[[0,1],[0,2]],"singular",t,i,[-1,8,-1,8],!1),a=ve(e.positionStr[0]+(parseInt(e.positionStr.substring(1))+1)),p=e.positionStr[0]+(parseInt(e.positionStr.substring(1))+2),ge(o.canMove,p)&&me(n,a)&&o.canMove.splice(o.canMove.indexOf(p),1)):o=this.generatePositions(e.positionCoord,[[0,1]],"singular",t,i,[-1,8,-1,8],!1),0!=this.moveNb&&"pawn"==this.gameStates[this.moveNb].lastMove.piece.type&&Math.abs(this.gameStates[this.moveNb].lastMove.originCoord[1]-this.gameStates[this.moveNb].lastMove.destinationCoord[1])>1&&(c="white"==this.gameStates[this.moveNb].lastMove.piece.colour?[this.gameStates[this.moveNb].lastMove.originCoord[0],this.gameStates[this.moveNb].lastMove.originCoord[1]+1]:[this.gameStates[this.moveNb].lastMove.originCoord[0],this.gameStates[this.moveNb].lastMove.originCoord[1]-1]);var g=[[1,1],[-1,1]];for(var m in g){var d=g[m];(l=[e.positionCoord[0],e.positionCoord[1]])[0]+=d[0],l[1]+=d[1],this.isInsideField(l,[-1,8,-1,8])&&(me(i,l)&&o.canAttack.push(be(l)),void 0!==c&&de(l,c)&&o.canAttack.push(be(l)))}return o}0==e.numberMoves?(o=this.generatePositions(e.positionCoord,[[0,-1],[0,-2]],"singular",t,i,[-1,8,-1,8],!1),a=ve(e.positionStr[0]+(parseInt(e.positionStr.substring(1))-1)),p=e.positionStr[0]+(parseInt(e.positionStr.substring(1))-2),ge(o.canMove,p)&&me(n,a)&&o.canMove.splice(o.canMove.indexOf(p),1)):o=this.generatePositions(e.positionCoord,[[0,-1]],"singular",t,i,[-1,8,-1,8],!1),0!=this.moveNb&&"pawn"==this.gameStates[this.moveNb].lastMove.piece.type&&Math.abs(this.gameStates[this.moveNb].lastMove.originCoord[1]-this.gameStates[this.moveNb].lastMove.destinationCoord[1])>1&&(c="white"==this.gameStates[this.moveNb].lastMove.piece.colour?[this.gameStates[this.moveNb].lastMove.originCoord[0],this.gameStates[this.moveNb].lastMove.originCoord[1]+1]:[this.gameStates[this.moveNb].lastMove.originCoord[0],this.gameStates[this.moveNb].lastMove.originCoord[1]-1]);g=[[-1,-1],[1,-1]];for(var m in g){d=g[m];(l=[e.positionCoord[0],e.positionCoord[1]])[0]+=d[0],l[1]+=d[1],this.isInsideField(l,[-1,8,-1,8])&&(me(i,l)&&o.canAttack.push(be(l)),void 0!==c&&de(l,c)&&o.canAttack.push(be(l)))}return o}}}class Le extends Ie{constructor(){super(),this.variant=2,this.type="xiangqi",this.cwidth=450,this.cheight=500,this.nbSqPSideX=9,this.nbSqPSideY=10,this.subSizeX=300,this.subSizeY=300,this.imageSrcs=["images/xiangqi/pieces.png","images/xiangqi/board.png"],this.coordinates={0:[0,0],1:[0,1],2:[1,0],3:[1,1],7:[2,1],4:[3,0],5:[3,1],6:[2,0],8:[4,0],9:[4,1],10:[5,0],11:[5,1],12:[6,0],13:[6,1]}}getPromotionConfigs(e,t){var i=[];switch(e.type){case"pawn":"white"==e.colour?6==t[1]&&i.push({type:"promotedpawn",spriteCoord:12}):5==t[1]&&i.push({type:"promotedpawn",spriteCoord:13})}return i}inBetweenElephantJump(e,t){var i=ve(e),o=ve(t),s=[];return i[0]>o[0]?s.push(o[0]+1):s.push(i[0]+1),i[1]>o[1]?s.push(o[1]+1):s.push(i[1]+1),s}inBetweenKnightJump(e,t){var i=ve(e),o=ve(t),s=i[0]-o[0],n=i[1]-o[1];return Math.abs(s)>Math.abs(n)?s<0?[o[0]-1,o[1]]:[o[0]+1,o[1]]:n<0?[o[0],o[1]-1]:[o[0],o[1]+1]}getPieceMoves(e,t,i){switch(e.type){case"king":return"white"==e.colour?this.generatePositions(e.positionCoord,[[-1,0],[0,1],[0,-1],[1,0]],"singular",t,i,[2,6,-1,3]):this.generatePositions(e.positionCoord,[[-1,0],[0,1],[0,-1],[1,0]],"singular",t,i,[2,6,6,10]);case"counselor":return"white"==e.colour?this.generatePositions(e.positionCoord,[[-1,-1],[-1,1],[1,1],[1,-1]],"singular",t,i,[2,6,-1,3]):this.generatePositions(e.positionCoord,[[-1,-1],[-1,1],[1,1],[1,-1]],"singular",t,i,[2,6,6,10]);case"catapult":return this.generatePositions(e.positionCoord,[[-1,0],[0,1],[1,0],[0,-1]],"plural",t,i,[-1,9,-1,10],!1,!0);case"elephant":var o={canMove:[],canAttack:[]};if("white"==e.colour){for(var s in(n=this.generatePositions(e.positionCoord,[[-2,-2],[-2,2],[2,2],[2,-2]],"singular",t,i,[-1,9,-1,5])).canMove)r=this.inBetweenElephantJump(n.canMove[s],e.positionStr),me(i.concat(t),r)||o.canMove.push(n.canMove[s]);for(var s in n.canAttack)r=this.inBetweenElephantJump(n.canAttack[s],e.positionStr),me(i.concat(t),r)||o.canAttack.push(n.canAttack[s]);return o}for(var s in(n=this.generatePositions(e.positionCoord,[[-2,-2],[-2,2],[2,2],[2,-2]],"singular",t,i,[-1,9,4,10])).canMove)r=this.inBetweenElephantJump(n.canMove[s],e.positionStr),me(i.concat(t),r)||o.canMove.push(n.canMove[s]);for(var s in n.canAttack)r=this.inBetweenElephantJump(n.canAttack[s],e.positionStr),me(i.concat(t),r)||o.canAttack.push(n.canAttack[s]);return o;case"knight":var n,r;o={canMove:[],canAttack:[]};for(var s in(n=this.generatePositions(e.positionCoord,[[-2,1],[-1,2],[1,2],[2,1],[2,-1],[1,-2],[-1,-2],[-2,-1]],"singular",t,i,[-1,9,-1,10])).canMove)r=this.inBetweenKnightJump(n.canMove[s],e.positionStr),me(i.concat(t),r)||o.canMove.push(n.canMove[s]);for(var s in n.canAttack)r=this.inBetweenElephantJump(n.canAttack[s],e.positionStr),me(i.concat(t),r)||o.canAttack.push(n.canAttack[s]);return o;case"rook":return this.generatePositions(e.positionCoord,[[-1,0],[0,1],[1,0],[0,-1]],"plural",t,i,[-1,9,-1,10]);case"pawn":return"white"==e.colour?this.generatePositions(e.positionCoord,[[0,1]],"singular",t,i,[-1,9,-1,10]):this.generatePositions(e.positionCoord,[[0,-1]],"singular",t,i,[-1,9,-1,10]);case"promotedpawn":return"white"==e.colour?this.generatePositions(e.positionCoord,[[0,1],[-1,0],[1,0]],"singular",t,i,[-1,9,-1,10]):this.generatePositions(e.positionCoord,[[0,-1],[-1,0],[1,0]],"singular",t,i,[-1,9,-1,10])}}}class De extends Ie{constructor(e){super(),this.variant=3,this.type="shogi",this.cwidth=450,this.cheight=450,this.cCptOneWidth=150,this.cCptOneHeight=150,this.cCptTwoWidth=150,this.cCptTwoHeight=150,this.nbSqPSideX=9,this.nbSqPSideY=9,this.subSizeX=225,this.subSizeY=250,this.prisoners,this.images={board:null,pieces:null,sideboard:null},this.imageSrcs=["images/shogi/pieces.png","images/shogi/board.jpg","images/shogi/sideboard.jpg"],this.coordinates={0:[0,2],1:[0,3],2:[0,0],3:[0,1],4:[1,2],5:[1,3],6:[1,0],7:[1,1],8:[2,2],9:[2,3],10:[2,0],11:[2,1],12:[3,2],13:[3,3],14:[3,0],15:[3,1],16:[4,2],17:[4,3],18:[4,0],19:[4,1],20:[5,2],21:[5,3],22:[5,0],23:[5,1],24:[6,2],25:[6,3],26:[6,0],27:[6,1],28:[7,2],29:[7,3],30:[7,0],31:[7,1]}}getPromotionConfigs(e,t){var i=[];if(e.originalType==e.type&&"gold"!=e.type&&"king"!=e.type)if("white"==e.colour){if(t[1]>6||e.positionStr[1]>6)switch("gold"!=e.type&&"silver"!=e.type&&"rook"!=e.type&&"bishop"!=e.type||i.push({type:e.type,spriteCoord:e.spriteCoord}),e.type){case"pawn":9==t[1]?i.push({type:"gold",spriteCoord:29}):(i.push({type:e.type,spriteCoord:e.spriteCoord}),i.push({type:"gold",spriteCoord:29}));break;case"lance":9==t[1]?i.push({type:"gold",spriteCoord:25}):(i.push({type:e.type,spriteCoord:e.spriteCoord}),i.push({type:"gold",spriteCoord:25}));break;case"knight":9==t[1]||8==t[1]?i.push({type:"gold",spriteCoord:21}):(i.push({type:e.type,spriteCoord:e.spriteCoord}),i.push({type:"gold",spriteCoord:21}));break;case"silver":i.push({type:"gold",spriteCoord:17});break;case"rook":i.push({type:"prook",spriteCoord:5});break;case"bishop":i.push({type:"pbishop",spriteCoord:9})}}else if(t[1]<4||e.positionStr[1]<4)switch("gold"!=e.type&&"silver"!=e.type&&"rook"!=e.type&&"bishop"!=e.type||i.push({type:e.type,spriteCoord:e.spriteCoord}),e.type){case"pawn":1==t[1]?i.push({type:"gold",spriteCoord:31}):(i.push({type:e.type,spriteCoord:e.spriteCoord}),i.push({type:"gold",spriteCoord:31}));break;case"lance":1==t[1]?i.push({type:"gold",spriteCoord:27}):(i.push({type:e.type,spriteCoord:e.spriteCoord}),i.push({type:"gold",spriteCoord:27}));break;case"knight":1==t[1]||2==t[1]?i.push({type:"gold",spriteCoord:23}):(i.push({type:e.type,spriteCoord:e.spriteCoord}),i.push({type:"gold",spriteCoord:23}));break;case"silver":i.push({type:"gold",spriteCoord:19});break;case"rook":i.push({type:"prook",spriteCoord:7});break;case"bishop":i.push({type:"pbishop",spriteCoord:11})}return i}createPrisonerList(){var e={pawn:0,lance:0,knight:0,silver:0,gold:0,bishop:0,rook:0},t={pawn:0,lance:0,knight:0,silver:0,gold:0,bishop:0,rook:0};for(var i in D.gameStates[D.moveNb].pieces)0==D.gameStates[D.moveNb].pieces[i].alive&&("white"==D.gameStates[D.moveNb].pieces[i].colour?e[D.gameStates[D.moveNb].pieces[i].originalType]+=1:t[D.gameStates[D.moveNb].pieces[i].originalType]+=1);this.prisoners={wDeadPieces:e,bDeadPieces:t}}getBoardStrEmptySquares(e,t,i,o=null,s=null,n=null,r=null){var a=[];null==o&&(o=0),null==s&&(s=0);for(var p=o;p<e;p++)if(null==n||!n.includes(p))for(var c=s;c<t;c++)null!=r&&r.includes(c)||me(i,[p,c])||a.push(be([p,c]));return a}getSpriteCoord(e,t){switch(e){case"lance":return"white"==t?24:26;case"knight":return"white"==t?20:22;case"silver":return"white"==t?16:18;case"gold":return"white"==t?12:14;case"rook":return"white"==t?4:6;case"bishop":return"white"==t?8:10;case"pawn":return"white"==t?28:30}}getPieceMoves(e,t,i){if(!e.alive){switch(e.type){case"pawn":var s,n,r,a,p={canMove:[],canAttack:[]},c=[];for(var l in D.gameStates[D.moveNb].pieces)"pawn"==(s=D.gameStates[D.moveNb].pieces[l]).type&&s.alive&&s.colour==o&&c.push(s.positionCoord[0]);for(var g in n="white"==e.colour?this.getBoardStrEmptySquares(this.nbSqPSideX,this.nbSqPSideY-1,t.concat(i),null,null,c,null):this.getBoardStrEmptySquares(this.nbSqPSideX,this.nbSqPSideY,t.concat(i),null,1,c,null))for(var l in a=ke(D.gameStates[D.moveNb]),r=n[g],a.pieces)if(a.pieces[l].pid==e.pid){a.pieces[l].positionStr=r,a.pieces[l].positionCoord=ve(r),a.pieces[l].alive=!0,Me(this,a,He(o))||p.canMove.push(r);break}return p;case"lance":return"white"==e.colour?{canMove:this.getBoardStrEmptySquares(this.nbSqPSideX,this.nbSqPSideY-2,t.concat(i),null,null,null,null),canAttack:[]}:{canMove:this.getBoardStrEmptySquares(this.nbSqPSideX,this.nbSqPSideY,t.concat(i),null,2,null,null),canAttack:[]}}return{canMove:this.getBoardStrEmptySquares(this.nbSqPSideX,this.nbSqPSideY,t.concat(i)),canAttack:[]}}switch(e.type){case"king":return this.generatePositions(e.positionCoord,[[-1,1],[-1,0],[-1,-1],[0,1],[0,-1],[1,1],[1,0],[1,-1]],"singular",t,i,[-1,9,-1,9]);case"lance":return"white"==e.colour?this.generatePositions(e.positionCoord,[[0,1]],"plural",t,i,[-1,9,-1,9]):this.generatePositions(e.positionCoord,[[0,-1]],"plural",t,i,[-1,9,-1,9]);case"knight":return"white"==e.colour?this.generatePositions(e.positionCoord,[[-1,2],[1,2]],"singular",t,i,[-1,9,-1,9]):this.generatePositions(e.positionCoord,[[-1,-2],[1,-2]],"singular",t,i,[-1,9,-1,9]);case"silver":return"white"==e.colour?this.generatePositions(e.positionCoord,[[-1,1],[-1,-1],[0,1],[1,1],[1,-1]],"singular",t,i,[-1,9,-1,9]):this.generatePositions(e.positionCoord,[[-1,1],[-1,-1],[0,-1],[1,1],[1,-1]],"singular",t,i,[-1,9,-1,9]);case"gold":return"white"==e.colour?this.generatePositions(e.positionCoord,[[-1,1],[-1,0],[0,1],[0,-1],[1,1],[1,0]],"singular",t,i,[-1,9,-1,9]):this.generatePositions(e.positionCoord,[[-1,-1],[-1,0],[0,1],[0,-1],[1,-1],[1,0]],"singular",t,i,[-1,9,-1,9]);case"rook":return this.generatePositions(e.positionCoord,[[-1,0],[0,1],[1,0],[0,-1]],"plural",t,i,[-1,9,-1,9]);case"bishop":return this.generatePositions(e.positionCoord,[[-1,1],[1,1],[1,-1],[-1,-1]],"plural",t,i,[-1,9,-1,9]);case"pawn":return"white"==e.colour?this.generatePositions(e.positionCoord,[[0,1]],"singular",t,i,[-1,9,-1,9]):this.generatePositions(e.positionCoord,[[0,-1]],"singular",t,i,[-1,9,-1,9]);case"prook":var m=this.generatePositions(e.positionCoord,[[-1,0],[0,1],[1,0],[0,-1]],"plural",t,i,[-1,9,-1,9]),d=this.generatePositions(e.positionCoord,[[-1,1],[-1,-1],[1,1],[1,-1]],"singular",t,i,[-1,9,-1,9]);return{canMove:m.canMove.concat(d.canMove),canAttack:m.canAttack.concat(d.canAttack)};case"pbishop":var u=this.generatePositions(e.positionCoord,[[-1,1],[1,1],[1,-1],[-1,-1]],"plural",t,i,[-1,9,-1,9]);d=this.generatePositions(e.positionCoord,[[-1,0],[0,1],[0,-1],[1,0]],"singular",t,i,[-1,9,-1,9]);return{canMove:u.canMove.concat(d.canMove),canAttack:u.canAttack.concat(d.canAttack)}}}}function xe(e,t){var i=t.getBoundingClientRect();return[Math.floor((e.clientX-i.left)/L),Math.floor((e.clientY-i.top)/L)]}function He(e){return"white"==e?"black":"white"}function Oe(){return o==(D.moveNb%2==0?"white":"black")}function Xe(e,t,i){if(Oe()&&e.eyeNb==e.moveNb&&p)if(r==o){if("two"==t){var s=qe(be(xe(i,G)));if(e.prisoners[o[0]+"DeadPieces"][s]>0)for(var n in e.gameStates[e.moveNb].pieces){if((a=e.gameStates[e.moveNb].pieces[n]).colour==o&&a.type==s&&0==a.alive){e.focus.piece=a,e.focus.validSquares=e.moves[a.pid],Ee(e,e.moveNb);break}}}}else if("one"==t){s=qe(be(xe(i,V)));if(e.prisoners[o[0]+"DeadPieces"][s]>0)for(var n in e.gameStates[e.moveNb].pieces){var a;if((a=e.gameStates[e.moveNb].pieces[n]).colour==o&&a.type==s&&0==a.alive){e.focus.piece=a,e.focus.validSquares=e.moves[a.pid],Ee(e,e.moveNb);break}}}}function Ye(t,g){if(Oe()&&t.eyeNb==t.moveNb&&p){var m,d,u=function(e){return"white"==r?e[1]=-e[1]+B:(e[0]=-e[0]+I-1,e[1]+=1),n[e[0]]+e[1]}(xe(g,s));if(null==t.focus.piece){for(var h in t.gameStates[t.moveNb].pieces)if((m=t.gameStates[t.moveNb].pieces[h]).positionStr==u&&m.colour==o&&m.alive){t.focus.piece=m,t.focus.validSquares=t.moves[m.pid],Ee(t,t.moveNb);break}}else if(t.promoting&&(ge(d=ue(t.promotingSquare,t.promotionConfigs.length),u)?t.promotingChoice=t.promotionConfigs[d.indexOf(u)]:(t.focus.piece=null,t.promoting=!1,Ee(t,t.moveNb))),ge(t.focus.validSquares.canMove,u)||ge(t.focus.validSquares.canAttack,u)||t.promoting){if(0==t.promoting&&(3!=l||0!=t.focus.piece.alive)&&(t.promotingSquare=u,t.promotionConfigs=t.getPromotionConfigs(t.focus.piece,u),0!=t.promotionConfigs.length))return t.promoting=!0,void Ee(t,t.moveNb);var v=ke(t.gameStates[t.moveNb]);for(var h in v.pieces){if(v.pieces[h].pid==t.focus.piece.pid&&v.pieces[h].alive){for(var b in m=v.pieces[h],v.pieces)if(0==t.promoting){if(v.pieces[b].positionStr==u&&v.pieces[b].alive){v.pieces[b].alive=!1,3==l&&(v.pieces[b].colour=He(v.pieces[b].colour),v.pieces[b].type=v.pieces[b].originalType,v.pieces[b].spriteCoord=t.getSpriteCoord(v.pieces[b].type,v.pieces[b].colour),v.pieces[b].positionStr=null,v.pieces[b].positionCoord=null);break}}else if(v.pieces[b].positionStr==t.promotingSquare&&v.pieces[b].alive){v.pieces[b].alive=!1,3==l&&(v.pieces[b].colour=He(v.pieces[b].colour),v.pieces[b].type=v.pieces[b].originalType,v.pieces[b].spriteCoord=t.getSpriteCoord(v.pieces[b].type,v.pieces[b].colour),v.pieces[b].positionStr=null,v.pieces[b].positionCoord=null);break}if(0!=t.moveNb&&"pawn"==v.lastMove.piece.type&&1==l&&"pawn"==m.type&&Math.abs(v.lastMove.originCoord[1]-v.lastMove.destinationCoord[1])>1)if("white"==v.lastMove.piece.colour){if(be([v.lastMove.originCoord[0],v.lastMove.originCoord[1]+1])==u)for(var b in v.pieces)if(v.pieces[b].pid==v.lastMove.piece.pid){v.pieces[b].alive=!1;break}}else if(be([v.lastMove.originCoord[0],v.lastMove.originCoord[1]-1])==u)for(var b in v.pieces)if(v.pieces[b].pid==v.lastMove.piece.pid){v.pieces[b].alive=!1;break}if("king"==m.type&&1==l){var S=ve(t.focus.piece.positionStr)[0]-ve(u)[0];if(Math.abs(S)>1)if("white"==m.colour){if(S>0){for(var b in v.pieces)if(0==v.pieces[b].pid){v.pieces[b].positionStr="d1",v.pieces[b].positionCoord=ve("d1");break}}else for(var b in v.pieces)if(7==v.pieces[b].pid){v.pieces[b].positionStr="f1",v.pieces[b].positionCoord=ve("f1");break}}else if(S>0){for(var b in v.pieces)if(16==v.pieces[b].pid){v.pieces[b].positionStr="d8",v.pieces[b].positionCoord=ve("d8");break}}else for(var b in v.pieces)if(23==v.pieces[b].pid){v.pieces[b].positionStr="f8",v.pieces[b].positionCoord=ve("f8");break}}0==t.promoting?(m.positionStr=u,m.positionCoord=ve(u)):(m.positionStr=t.promotingSquare,m.positionCoord=ve(t.promotingSquare),m.type=t.promotingChoice.type,m.spriteCoord=t.promotingChoice.spriteCoord),m.numberMoves+=1,v.lastMove.piece=m;break}if(v.pieces[h].pid==t.focus.piece.pid&&0==v.pieces[h].alive){m=v.pieces[h],v.lastMove.piece=m,m.positionStr=u,m.numberMoves+=1,m.positionCoord=ve(u),m.alive=!0;break}}v.check=!1;var f=Me(t,v,He(o));null!=f&&(v.check=f),null!=t.focus.piece.positionStr?(v.lastMove.originStr=t.focus.piece.positionStr,v.lastMove.originCoord=ve(t.focus.piece.positionStr)):(v.lastMove.originStr=null,v.lastMove.originCoord=null),v.lastMove.destinationStr=u,v.lastMove.destinationCoord=ve(u),v.moveNb+=1,1==v.moveNb?(v.timeremaining={date:(new Date).getTime(),timeleftmillis:6e4*c},A=we(fe(6e4*c),"opponenttime")):2==v.moveNb?(v.timeremaining={date:(new Date).getTime(),timeleftmillis:6e4*c-Se(t.gameStates[t.moveNb].timeremaining.date)+1e3*a},Ce(E),ye(v.timeremaining.timeleftmillis,"playertime"),A=we(fe(6e4*c),"opponenttime")):(v.timeremaining={date:(new Date).getTime(),timeleftmillis:t.gameStates[t.moveNb-1].timeremaining.timeleftmillis-Se(t.gameStates[t.moveNb].timeremaining.date)+1e3*a},Ce(E),ye(v.timeremaining.timeleftmillis,"playertime"),A=we(fe(t.gameStates[t.moveNb].timeremaining.timeleftmillis),"opponenttime")),i.emit("sendGameState",{gid:e,state:v}),t.gameStates.push(v),t.moveNb+=1,t.eyeNb+=1,t.focus.piece=null,t.moves={},t.promoting=!1,t.promotionConfigs=[],T.innerHTML="&nbsp;"+t.eyeNb,q.innerHTML="&nbsp;"+t.moveNb,3==l&&t.createPrisonerList(),Ee(t,t.moveNb)}else t.focus.piece=null,Ee(t,t.moveNb)}}switch(l){case 1:k.innerHTML="<strong>Mode: Western Chess</strong> "+c+"+"+a+'<br/><br/>Use arrow keys &#8593; and &#8595; to navigate through moves<br/><br/>Press "w" and "b" to change perspective',M.style.width="400px",N.style.width="400px","white"==o?(M.innerHTML="&nbsp;&nbsp;"+v+" ("+S+")",N.innerHTML="&nbsp;&nbsp;"+g+" ("+d+")"):(M.innerHTML="&nbsp;&nbsp;"+g+" ("+d+")",N.innerHTML="&nbsp;&nbsp;"+v+" ("+S+")"),D=new Be(r);break;case 2:k.innerHTML="<strong>Mode: Xiangqi</strong> "+c+"+"+a+'<br/><br/>Use arrow keys &#8593; and &#8595; to navigate through moves<br/><br/>Press "w" and "b" to change perspective',M.style.width="450px",N.style.width="450px","white"==o?(M.innerHTML="&nbsp;&nbsp;"+v+" ("+f+")",N.innerHTML="&nbsp;&nbsp;"+g+" ("+u+")"):(M.innerHTML="&nbsp;&nbsp;"+g+" ("+u+")",N.innerHTML="&nbsp;&nbsp;"+v+" ("+f+")"),D=new Le(r);break;case 3:k.innerHTML="<strong>Mode:Shogi</strong> "+c+"+"+a+'<br/><br/>Use arrow keys &#8593; and &#8595; to navigate through moves<br/><br/>Press "w" and "b" to change perspective',M.style.width="450px",N.style.width="450px","white"==o?(M.innerHTML="&nbsp;&nbsp;"+v+" ("+y+")",N.innerHTML="&nbsp;&nbsp;"+g+" ("+h+")"):(M.innerHTML="&nbsp;&nbsp;"+g+" ("+h+")",N.innerHTML="&nbsp;&nbsp;"+v+" ("+y+")"),D=new De(r)}!function(e,t,i){var o=e.imageSrcs.length,s=(e,t)=>{0!=--o||i(e)};for(var n in e.imageSrcs)t(e,n,s)}(D,function(e,t,i){var o=function(s){s.target.removeEventListener("load",o);var n=s.target.src.match(/([\w\d_-]*)\.?[^\\\/]*$/i)[1];"pieces"==n?e.images.pieces=s.target:"sideboard"==n?e.images.sideboard=s.target:e.images.board=s.target,i(e,t)},s=new Image;s.addEventListener("load",o,!1),s.src=e.imageSrcs[t]},function(){s.width=D.cwidth,s.height=D.cheight,L=D.cwidth/D.nbSqPSideX,I=D.nbSqPSideX,B=D.nbSqPSideY,w.style.marginTop="-255px",C.style.marginTop=Math.round(D.cheight-195).toString()+"px",i.emit("getInitBoardState",D.variant),i.on("getInitBoardState",t=>{D.gameStates.push(t),i.emit("getBoardStates",e)}),i.on("getBoardStates",t=>{if(D.moveNb=t.length,D.eyeNb=t.length,T.innerHTML="&nbsp;"+D.eyeNb,q.innerHTML="&nbsp;"+D.moveNb,null!=t)for(var s in t)D.gameStates.push(t[s].gamestate);if(3==l&&D.createPrisonerList(),p){if(x=!1,Oe()){for(var n in D.generateValidMoves(),D.moves)if(0!=D.moves[n].canMove.length||0!=D.moves[n].canAttack.length){x=!0;break}if(0==x){for(var r in z=D.getSquareOccupancy(D.gameStates[D.moveNb],He(o)),R=z[0],F=z[1],D.gameStates[D.moveNb].pieces)if((H=D.gameStates[D.moveNb].pieces[r]).colour==o&&"king"==H.type){O=H.positionStr;break}for(var a in Y=!0,D.gameStates[D.moveNb].pieces){if(0==Y)break;if(D.gameStates[D.moveNb].pieces[a].colour==He(o)&&D.gameStates[D.moveNb].pieces[a].alive)for(var g in(X=D.getPieceMoves(D.gameStates[D.moveNb].pieces[a],R,F)).canAttack)if(X.canAttack[g]==O){Y=!1;break}}Y?(i.emit("gameover",{gid:e,type:"stalemate",winnercolour:"grey"}),alert("stalemate")):(i.emit("gameover",{gid:e,type:"mate",winner:He(o)}),alert("mate"))}}p&&(Oe()?0!=D.moveNb&&(1==D.moveNb?E=we(fe(6e4*c-Se(D.gameStates[D.moveNb].timeremaining.date)),"playertime"):2==D.moveNb?(E=we(fe(6e4*c-Se(D.gameStates[D.moveNb].timeremaining.date)),"playertime"),ye(D.gameStates[D.moveNb].timeremaining.timeleftmillis,"opponenttime")):(E=we(fe(D.gameStates[D.moveNb-1].timeremaining.timeleftmillis)-Se(D.gameStates[D.moveNb].timeremaining.date),"playertime"),ye(D.gameStates[D.moveNb].timeremaining.timeleftmillis,"opponenttime"))):0!=D.moveNb&&(1==D.moveNb?A=we(fe(6e4*c-Se(D.gameStates[D.moveNb].timeremaining.date)),"opponenttime"):2==D.moveNb?(A=we(fe(6e4*c-Se(D.gameStates[D.moveNb].timeremaining.date)),"opponenttime"),ye(D.gameStates[D.moveNb].timeremaining.timeleftmillis,"playertime")):(A=we(fe(D.gameStates[D.moveNb-1].timeremaining.timeleftmillis)-Se(D.gameStates[D.moveNb].timeremaining.date),"opponenttime"),ye(D.gameStates[D.moveNb].timeremaining.timeleftmillis,"playertime"))))}else alert("this game is over");Ee(D,D.moveNb)}),i.on("sendGameState",t=>{if(console.log("i've received the state",t),D.gameStates.push(t),D.moveNb+=1,D.eyeNb=D.moveNb,T.innerHTML="&nbsp;"+D.eyeNb,q.innerHTML="&nbsp;"+D.moveNb,3==l&&D.createPrisonerList(),Ee(D,D.moveNb),p){if(x=!1,Oe()){for(var s in D.generateValidMoves(),D.moves)if(0!=D.moves[s].canMove.length||0!=D.moves[s].canAttack.length){x=!0;break}if(0==x){for(var n in z=D.getSquareOccupancy(D.gameStates[D.moveNb],He(o)),R=z[0],F=z[1],D.gameStates[D.moveNb].pieces)if((H=D.gameStates[D.moveNb].pieces[n]).colour==o&&"king"==H.type){O=H.positionStr;break}for(var r in Y=!0,D.gameStates[D.moveNb].pieces){if(0==Y)break;if(D.gameStates[D.moveNb].pieces[r].colour==He(o)&&D.gameStates[D.moveNb].pieces[r].alive)for(var a in(X=D.getPieceMoves(D.gameStates[D.moveNb].pieces[r],R,F)).canAttack)if(X.canAttack[a]==O){Y=!1;break}}Y?(i.emit("gameover",{gid:e,type:"stalemate",winnercolour:"grey"}),Ce(A),alert("stalemate")):(i.emit("gameover",{gid:e,type:"mate",winner:He(o)}),Ce(A),alert("mate"))}else 1==D.moveNb?E=we(fe(6e4*c-Se(D.gameStates[D.moveNb].timeremaining.date)),"playertime"):2==D.moveNb?(Ce(A),ye(D.gameStates[D.moveNb].timeremaining.timeleftmillis,"opponenttime"),E=we(fe(6e4*c-Se(D.gameStates[D.moveNb].timeremaining.date)),"playertime")):(Ce(A),ye(D.gameStates[D.moveNb].timeremaining.timeleftmillis,"opponenttime"),E=we(fe(D.gameStates[D.moveNb-1].timeremaining.timeleftmillis)-Se(D.gameStates[D.moveNb].timeremaining.date),"playertime"))}}else alert("this game is already marked as over")}),i.on("gameover",e=>{Ce(A),alert(e)}),"white"!=o&&"black"!=o||(s.addEventListener("mousedown",e=>{Ye(D,e)}),3==l&&(G.addEventListener("mousedown",e=>{Xe(D,"two",e)}),V.addEventListener("mousedown",e=>{Xe(D,"one",e)}))),T.innerHTML="&nbsp;"+D.eyeNb,q.innerHTML="&nbsp;"+D.moveNb,document.addEventListener("keydown",function(e){switch(null!=D.focus.piece&&(D.focus.piece=null),e.keyCode){case 37:D.eyeNb>0&&(D.eyeNb-=1),Ee(D,D.eyeNb);break;case 38:case 39:D.eyeNb<D.moveNb&&(D.eyeNb+=1),Ee(D,D.eyeNb);break;case 40:D.eyeNb>0&&(D.eyeNb-=1),Ee(D,D.eyeNb);break;case 66:r="black","white"==o?(w.style.marginTop=Math.round(D.cheight-195).toString()+"px",C.style.marginTop="-255px"):(w.style.marginTop="-255px",C.style.marginTop=Math.round(D.cheight-195).toString()+"px"),Ee(D,D.eyeNb);break;case 87:r="white",3==l&&($.style.marginTop="-200px",$.style.marginLeft="-355px",j.style.marginTop="100px",j.style.marginLeft="255px"),"white"==o?(w.style.marginTop="-255px",C.style.marginTop=Math.round(D.cheight-195).toString()+"px"):(w.style.marginTop=Math.round(D.cheight-195).toString()+"px",C.style.marginTop="-255px"),Ee(D,D.eyeNb)}T.innerHTML="&nbsp;"+D.eyeNb,q.innerHTML="&nbsp;"+D.moveNb})})})});